# Auth Service Integration Checklist

This checklist ensures the AuthService is properly integrated and ready for use.

---

## Pre-Integration Setup

### 1. Dependencies Check

- [ ] `shared_preferences: ^2.2.2` - Already in pubspec.yaml
- [ ] `dio: ^5.4.0` - Already in pubspec.yaml
- [ ] `flutter_riverpod: ^3.0.3` - Already in pubspec.yaml
- [ ] Run `flutter pub get` to ensure all dependencies are installed

### 2. File Structure Verification

```
lib/
├── data/
│   ├── models/
│   │   └── auth_models.dart ✓
│   └── services/
│       ├── api_client.dart ✓
│       └── auth_service.dart ✓ (implemented)
├── presentation/
│   ├── notifiers/
│   │   └── auth_notifier.dart ✓
│   └── providers/
│       ├── auth_provider.dart ✓
│       └── auth_state.dart ✓
```

- [ ] Verify all files exist
- [ ] No missing imports
- [ ] No circular dependencies

---

## Implementation Steps

### Step 1: Verify AuthService Implementation

- [ ] Open `client/lib/data/services/auth_service.dart`
- [ ] Confirm all methods are implemented:
  - [ ] `login(email, password)`
  - [ ] `signup(request)`
  - [ ] `logout()`
  - [ ] `refreshAccessToken()`
  - [ ] `getCurrentUser()`
  - [ ] `init(apiClient, preferences)`
- [ ] Check token storage keys are defined
- [ ] Verify error handling methods exist

### Step 2: Verify Auth Models

- [ ] Open `client/lib/data/models/auth_models.dart`
- [ ] Confirm model classes:
  - [ ] `LoginRequest`
  - [ ] `SignupRequest`
  - [ ] `AuthResponse`
  - [ ] `TokenResponse`
  - [ ] `UserData`
  - [ ] Exception classes (all 7 types)

### Step 3: Initialize AuthService in main.dart

- [ ] Open `main.dart`
- [ ] Add AuthService initialization:

```dart
import 'package:shared_preferences/shared_preferences.dart';
import 'package:client/data/services/api_client.dart';
import 'package:client/data/services/auth_service.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // Initialize API Client
  final apiClient = ApiClient();
  apiClient.init(
    baseUrl: 'http://localhost:8000/api',
    // Update with your actual backend URL
  );

  // Initialize Auth Service
  final authService = AuthService();
  final prefs = await SharedPreferences.getInstance();

  await authService.init(
    apiClient: apiClient,
    preferences: prefs,
  );

  runApp(
    ProviderScope(
      child: MyApp(
        authService: authService,
      ),
    ),
  );
}
```

- [ ] Pass authService to ApiClient if needed
- [ ] ProviderScope wraps MaterialApp
- [ ] No initialization errors on app start

### Step 4: Update ApiClient Initialization

- [ ] Verify ApiClient receives AuthService reference
- [ ] Check JWT interceptor receives authService
- [ ] Test that tokens are injected in requests

```dart
// In ApiClient.init()
_authService = authService; // Store reference
_dio.interceptors.add(_JwtInterceptor(_authService)); // Pass to interceptor
```

### Step 5: Verify Auth Provider

- [ ] Open `presentation/providers/auth_provider.dart`
- [ ] Confirm `authServiceProvider` returns AuthService instance
- [ ] Check all derived providers are defined:
  - [ ] `isAuthenticatedProvider`
  - [ ] `isAuthLoadingProvider`
  - [ ] `currentUserProvider`
  - [ ] `authErrorProvider`
  - [ ] `accessTokenProvider`
  - [ ] `tokenExpiryProvider`
  - [ ] `isSessionExpiringProvider`

### Step 6: Verify AuthNotifier

- [ ] Open `presentation/notifiers/auth_notifier.dart`
- [ ] Confirm it receives AuthService in constructor
- [ ] Check all methods call AuthService methods:
  - [ ] `login()` → `authService.login()`
  - [ ] `signup()` → `authService.signup()`
  - [ ] `logout()` → `authService.logout()`
  - [ ] `refreshAccessToken()` → `authService.refreshAccessToken()`

### Step 7: Update Screens

#### Login Screen
- [ ] Calls `ref.read(authProvider.notifier).login()`
- [ ] Handles AuthStateLoading for spinner
- [ ] Shows error message from AuthStateUnauthenticated
- [ ] Navigates on AuthStateAuthenticated

#### Signup Screen
- [ ] Calls `ref.read(authProvider.notifier).signup()` with SignupRequest
- [ ] Shows validation errors
- [ ] Handles network errors gracefully
- [ ] Navigates to home on success

#### Protected Screens
- [ ] Check `ref.watch(isAuthenticatedProvider)` before showing content
- [ ] Provide logout button
- [ ] Handle token expiration gracefully

---

## Testing Checklist

### Unit Tests

- [ ] Create `test/services/auth_service_test.dart`
- [ ] Mock SharedPreferences
- [ ] Mock ApiClient
- [ ] Test login() method
- [ ] Test signup() method
- [ ] Test logout() method
- [ ] Test refreshAccessToken() method
- [ ] Test token validation
- [ ] Test error mapping

**Sample test:**
```dart
test('login stores tokens on success', () async {
  // Mock successful login response
  final mockResponse = AuthResponse(
    accessToken: 'token',
    refreshToken: 'refresh',
    tokenType: 'bearer',
    expiresIn: 3600,
    user: UserData(...),
  );

  when(mockApiClient.post(...))
      .thenAnswer((_) async => Response(
        data: mockResponse.toJson(),
        statusCode: 200,
        requestOptions: RequestOptions(path: ''),
      ));

  // Call login
  final result = await authService.login(
    email: 'test@example.com',
    password: 'password',
  );

  // Verify
  expect(result.user.email, 'test@example.com');
  verify(mockPrefs.setString('access_token', 'token')).called(1);
});
```

### Integration Tests

- [ ] Create `integration_test/auth_flow_test.dart`
- [ ] Test complete login flow
- [ ] Test complete signup flow
- [ ] Test token refresh flow
- [ ] Test logout flow
- [ ] Test navigation after auth

### Manual Testing

#### Login Flow
- [ ] [ ] Start app, see login screen
- [ ] [ ] Enter valid credentials, tap login
- [ ] [ ] See loading spinner
- [ ] [ ] Successfully logged in, navigated to home
- [ ] [ ] Can access user profile (token working)
- [ ] [ ] Token exists in storage

#### Signup Flow
- [ ] [ ] Tap signup link
- [ ] [ ] Enter all required fields
- [ ] [ ] Tap signup button
- [ ] [ ] See loading spinner
- [ ] [ ] Successfully created account and logged in
- [ ] [ ] Navigated to home screen

#### Token Refresh
- [ ] [ ] Wait for token expiry
- [ ] [ ] Verify automatic refresh occurs
- [ ] [ ] No user interruption during refresh
- [ ] [ ] Continued API access after refresh

#### Logout
- [ ] [ ] From profile screen, tap logout
- [ ] [ ] Confirm logout dialog
- [ ] [ ] Navigated to login screen
- [ ] [ ] Tokens cleared from storage
- [ ] [ ] Cannot access protected screens

#### Error Handling
- [ ] [ ] Invalid email/password shows error message
- [ ] [ ] Network error shows network error message
- [ ] [ ] Email already exists shows specific message
- [ ] [ ] Server error shows graceful message
- [ ] [ ] Can retry after error

#### Storage Persistence
- [ ] [ ] Log in successfully
- [ ] [ ] Close app
- [ ] [ ] Reopen app
- [ ] [ ] User still logged in (session restored)
- [ ] [ ] User data is available

---

## Backend Integration

### API Endpoints Check

- [ ] Backend has `/auth/login` endpoint
  - [ ] Accepts POST with email, password
  - [ ] Returns access token, refresh token, user data
  - [ ] Status code 200 on success

- [ ] Backend has `/auth/signup` endpoint
  - [ ] Accepts POST with email, password, username, fullName
  - [ ] Returns access token, refresh token, user data
  - [ ] Status code 201 on success
  - [ ] Returns 400 if email exists

- [ ] Backend has `/auth/refresh-token` endpoint
  - [ ] Accepts POST with refresh_token
  - [ ] Returns new access token, refresh token
  - [ ] Status code 200 on success
  - [ ] Returns 401 if refresh token expired

- [ ] Backend has `/auth/me` endpoint
  - [ ] Accepts GET with Bearer token in header
  - [ ] Returns user data
  - [ ] Status code 200 on success
  - [ ] Returns 401 if token invalid

- [ ] Backend has `/auth/logout` endpoint
  - [ ] Accepts POST with Bearer token
  - [ ] Invalidates token on backend
  - [ ] Status code 200 on success

### Response Format Verification

Login/Signup Response:
```json
{
  "access_token": "...",
  "refresh_token": "...",
  "token_type": "bearer",
  "expires_in": 3600,
  "user": {
    "id": "...",
    "email": "...",
    "username": "...",
    "full_name": "...",
    "is_active": true,
    "is_verified": true,
    "created_at": "...",
    "last_login": null
  }
}
```

- [ ] Verify response format matches expectations
- [ ] Check field names (snake_case)
- [ ] Verify data types
- [ ] Check for optional fields

---

## Security Checklist

- [ ] [ ] Tokens stored in SharedPreferences (not in code)
- [ ] [ ] No tokens logged to console in production
- [ ] [ ] JWT token includes signature verification (backend)
- [ ] [ ] Refresh token has longer expiry than access token
- [ ] [ ] Tokens cleared on logout
- [ ] [ ] Tokens cleared on app uninstall
- [ ] [ ] HTTPS used in production (not HTTP)
- [ ] [ ] No credentials stored in SharedPreferences (only tokens)
- [ ] [ ] Token not exposed in error messages

---

## Deployment Checklist

### Pre-deployment

- [ ] [ ] All unit tests pass
- [ ] [ ] All integration tests pass
- [ ] [ ] Manual testing completed
- [ ] [ ] No console errors or warnings
- [ ] [ ] Remove debug logging
- [ ] [ ] Update backend URL for production
- [ ] [ ] Verify token expiry times
- [ ] [ ] Test with production API

### Deployment

- [ ] [ ] Build APK/IPA
- [ ] [ ] Test on physical device
- [ ] [ ] Verify storage permissions
- [ ] [ ] Test network connectivity handling
- [ ] [ ] Test app backgrounding/foregrounding

### Post-deployment

- [ ] [ ] Monitor crash logs
- [ ] [ ] Monitor authentication errors
- [ ] [ ] Verify token refresh is working
- [ ] [ ] Check storage usage
- [ ] [ ] Monitor user feedback

---

## Troubleshooting

### Problem: "AuthService not initialized"

**Solution:**
1. Ensure `authService.init()` is called in main.dart
2. Await the init call before running app
3. Check that SharedPreferences is initialized

### Problem: "JWT token not being added to headers"

**Solution:**
1. Verify AuthService is passed to ApiClient
2. Check that accessToken property returns non-null value
3. Ensure JWT interceptor is added to Dio
4. Verify token is not expired

### Problem: "Cannot login - 400 Bad Request"

**Solution:**
1. Check request format matches backend expectations
2. Verify field names are snake_case
3. Check password requirements (length, characters)
4. Verify email format

### Problem: "Token refresh fails - infinite loop"

**Solution:**
1. Check refresh endpoint returns valid new tokens
2. Verify expiresIn is positive
3. Ensure refresh token is stored and retrieved correctly
4. Check for circular refresh attempts

### Problem: "Tokens not clearing on logout"

**Solution:**
1. Verify _clearTokens() is called
2. Check SharedPreferences.remove() is successful
3. Ensure no other code is restoring tokens
4. Verify storage keys are correct

---

## Performance Checklist

- [ ] [ ] Token validation is fast (< 1ms)
- [ ] [ ] Login request completes within 5 seconds
- [ ] [ ] Token refresh doesn't block UI
- [ ] [ ] No memory leaks from timers
- [ ] [ ] Storage operations are efficient
- [ ] [ ] Error handling doesn't crash app

---

## Documentation Checklist

- [ ] [ ] README updated with auth flow
- [ ] [ ] API endpoints documented
- [ ] [ ] Error codes documented
- [ ] [ ] Usage examples provided
- [ ] [ ] Screens updated with auth logic
- [ ] [ ] Comments added to complex code
- [ ] [ ] Inline documentation complete

---

## Sign-off

- [ ] All items checked
- [ ] All tests passing
- [ ] Manual testing completed
- [ ] Code reviewed
- [ ] Ready for production

**Completed by:** _________________

**Date:** _________________

**Notes:** _______________________________________________________________

---

## Quick Start

1. Run `flutter pub get`
2. Initialize AuthService in main.dart
3. Update API endpoint URL for your backend
4. Implement login/signup screens with provided examples
5. Test complete flow with backend
6. Deploy with confidence

All items in this checklist should be completed before merging to main branch.
